\chapter{Event Reconstruction and Selection}
\label{chapter:reco_select}
\thispagestyle{myheadings}

\graphicspath{{3_Chapter_KLZ_Reconstruction_and_Selection/Figures/}}

KamLAND-ZEN uses detailed simulations defined in KLG4Sim, a GEANT4-based Monte Carlo (MC) simulation software. The MC simulated events are tuned with real calibration events to carefully match real detector response. Simulated and physical events produce detector responses that are reconstructed to extract higher-level information such as energy and position. The reconstructed event information is used for data-selection and spectrum fitting. This chapter discusses the MC simulation and event reconstruction procedures used in KamLAND-ZEN 800.

\section{Analysis Framework}
\subsection{Data Flow}
Figure \ref{fig:dataflow} outlines the data flow in KamLAND-ZEN. PMT signals are digitized in either KamFEE or MoGURA, the two DAQ systems discussed in the previous chapter, the digitized signals are stored in Kinoko Data Format (KDF). KDF files contain trigger information and timestamped, digitized PMT waveforms. KDF files also store run condition information in the header. The EventBuilder collates the waveforms of a single event and stores them in a serial file. A waveform analyzer reconstructs a hit time and charge (TQ) information for each of these waveforms. The RTQ files hold the Raw-TQ information for each PMT. Event vertices and visible energy are derived from the RTQ files through their respective reconstruction algorithms. There are secondary reconstructions that are also applied to the RTQ files, such as muon track fitting, flasher vetos, double pulse fit, and unphysical event selections. The general vector file (GVF) is used for the main physics analyses like the one presented in this thesis.

\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.3]{dataflow.png}
	\caption{Data flow in KamLAND from raw waveforms to analysis variables such as energy, vertex, total hit PMTs, etc. \cite{ozaki_phd}}
	\label{fig:dataflow}
\end{figure}

GVF files contain the following information:
\begin{itemize}
	\item \textbf{run number}
	\item \textbf{event number}
	\item \textbf{TimeStamp} based on DAQ clock time (25 nsec for KamFEE, 20 nsec for MoGDAQ)
	\item \textbf{unixtime} is the number of seconds from January 1st in 1970 and used for some run vetos
	\item \textbf{trigger type} records which trigger was used
	\item \textbf{event vertex and badness} event vertices and a radius from detector center is saved, along with a vertex fit quality parameter called badness 
	\item \textbf{energy/energy17} visible energies given by the fitter, energy17 is the energy estimate only using 17-inch PMTs
	\item \textbf{TotalChargeID/17/OD} sum of all PMT charges of each PMT type
	\item \textbf{numhit/numhit17} the number of hit PMTs/17-inch PMTs in each event.
	\item \textbf{NsumMax} a maximum number of hit PMTs in a single DAQ cycle within each event, a "peak" nhit of the event
	\item \textbf{N200OD} Maximum number of simultaneous hit OD pmts within 200nsec windows
	\item \textbf{muon entrance and direction} muon fitter results are recorded.
\end{itemize}

Finally, MoGURA events are associated with muon events acquired in KamFEE DAQ (FBE) and stored in a Muon-Neutron Vector File (MNVF) to search for neutron capture events that occur shortly after muons.

\section{Event Reconstruction}
\subsection{Waveform Analysis}
Each digitized waveform has 128 samples with 1.5ns sample times; this corresponds to a waveform digitization window of 192 ns. The waveforms are processed and TQ reconstructed with the following procedure.
\begin{itemize}
	\item \textbf{Smoothing} Each waveform is smoothed via a running-average first derivate.
	\item \textbf{Baseline adjustment} The baseline of each PMT is collected at the beginning of each run. This baseline is subtracted from each waveform.
	\item \textbf{Peak finding} Peaks are found with running-averaged 1st, 2nd, and 3rd derivatives.
	\item \textbf{Leading-edge and Trailing-edge tag} A leading-edge is stamped as 10ns before the peak voltage. The trailing edge is stamped when the waveform returns to baseline. An example of this time-stamping is shown in Figure \ref{fig:waveform_analysis}
	\item \textbf{Waveform Sum calculation} The waveform is integrated from the leading-edge to the trailing-edge.
\end{itemize}

\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.5]{waveform_analysis.png}
	\caption{An example of waveform analysis from thesis \cite{yoshida_phd}. (left) ADC counts of a real waveform after baseline subtraction. The left cyan line is the leading edge, the center red line is the peak position, and the right dark cyan line is a trailing-edge. (right) Clock calibration example on 25 nsec intervals.}
	\label{fig:waveform_analysis}
\end{figure}

When there are mulitple hits in one PMT waveform, the total charge of the hits and the earliest hit time is returned. This simplified information is used for the vertex and energy reconstruction. The multi-pe information is used for a double-pulse fit and a muon shower tag.

\subsection{PMT Corrections}
\subsection*{Low Gain Problem and HV Reductions}
Since ~2011, we observed that the gain of some of the 17-inch PMTs gradually decreased. As the gain of the PMTs fell, this compormises signal/background ratio and PMT waveform quality. It was also observed that the PMTs enter a low impedance state before the gain dropped. A HV current and voltage monitor allows for the real-time monitoring of this state. Usually a simple HV power cycle could recover normal PMT behavior. Since 2016, a auto HV power cycle mechanism was implemented to mitigate the low gain problem, but the root case is still unknown.

Each time the PMTs enter the low impedance state, the HV on that channel was reduced in 50-100 V increments. Over time, some of the channels had their HV reduced by 450 V. FIgure \ref{fig:lowgain_trend} shows the trend in low gain 17-inch PMTs.

\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.3]{lowgain_trend.png}
	\caption{The trend in the number of low gain 17-inch PMTs, before ZEN-800. The number of low gain channels increased gradually, while the sudden increases are from HV reductions performed since 2017 \cite{ozaki_phd}.}
	\label{fig:lowgain_trend}
\end{figure}

%/ TODO
Note about current low pmt gain analysis.

\subsection*{Bad Channel}
A channels is considered bad if the PMT meets one or more of the following criteria:
\begin{itemize}
	\item PMT pulses less than 0.6\% of the time over all events
	\item PMT pulses below 0.48\% for non-muon events
	\item PMT pulses less than 80\% of the time for high-energy muon events
	\item PMT is missing a waveform more than 10\% of the time
	\item Large discrepancy between the two ATWD hits
	\item High muon charge PMTs. A PMT may read much higher charge ($Q_{detected}$) than the average of its surrounding PMTs ($Q_{expected}$). A run is divided into 100 muon intervals, for each interval the criteria is defined as
	\[\frac{1}{N_{interval}}\sum_{i=1}^{N_{interval}}\left(\frac{1}{N_{muon}}\sum_{j=1}^{N_{muon}}\frac{(Q_{expected}-Q_{detected})^2}{Q_{expected}}\right)>1000\ p.e.\]
\end{itemize}
These bad channels are excluded from event reconstruction and physics analyses.

\subsection*{Dark Hit}
Thermal fluctuations can emit electrons off the photocathode leading to a PMT hit signal. These "dark hits" are an unavoidable hit-level background in PMT detectors, lowering the detector temperature reduces this effect. The dark hit rates are measured from run-to-run and are factored into our likelihood-maximizing reconstruction algorithms. The hit rate observed 50-100 ns before the PMT hittime rising edge is taken as the dark rate, Figure \ref{fig:darkrate} shows the PMT hittime distribution and the dark rate window.

\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.4]{darkrate.png}
	\caption{An example pmt hit time distribution from data run 14783, the 50-100 ns leading window is taken to measure the pmt dark hit rate. \cite{li_phd}.}
	\label{fig:darkrate}
\end{figure}

\subsection{Primary Vertex Fitter}
The primary vertex fitter provides a rough estimate of a scintillating event's location. This estimate serves as the input to a more thorough, but complex secondary fitter. The fit works by constructing a hit time residual distribution:
\begin{equation}
	T_{i}^{emit}=T_i-TOF_i = T_i - \frac{\left|R_i-r_{vertex}\right|}{c_eff}
	\label{eq:prim_vertex}
\end{equation}
Here $T_i$ is the hit time of the $i^{th}$ PMT, $TOF_i$ is the time it takes for a scintillation photon to traverse from the vertex position to the $i^{th}$ PMT position, $R_i$ is the PMT position, $r_{vertex}$ is the unknown vertex position to fit for, and $c_{eff}$ is the speed of light in the given medium. By fitting $T_i^{emit}$ to match the standard scintillation time profile, a primary $r_{vertex}$ is produced by the fitter.

\subsection{Secondary Fitter}
The secondary V2 fitter uses the $r_{vertex}$ given by the primary fitter to compute $T_0$ according to the equation \ref{eq:sec_v2}
\begin{equation}
	T_0 = \frac{\sum_i \left(T_i^{pmt}-TOF^{pmt}_i\right)\times Q_i}{\sum_iQ_i}- const.
	\label{eq:sec_v2}
\end{equation}
\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.4]{pmt_dist.png}
	\caption{Probability density function of 17-inch and 20-inch PMT hit times calculated from calibration data. The plot is from \cite{ozaki_phd} and originally from a 2005 calibration dataset.}
	\label{fig:pmt_pdfs}
\end{figure}
This $T_0$ is the charge weighted sum of $T_emit$ from \ref{eq:prim_vertex}. This $T_0$ serves as the universal start point of an event. From this time, each pmt hit time is
\begin{equation}
	\tau(x,y,z,T_0) = T^{pomt}_i-TOF_i^{pmt}-T_0
\end{equation}
Finally, these time-of-flight corrected and centered hit time distributions are used to create probability distributions for the 17 and 20 inch PMTs respectively. These PDFs are shown in Figure \ref{fig:pmt_pdfs}. The likelihood function for an individual PMT is defined as:
\begin{equation}
	\phi_i =\frac{\mu\times f_i(\tau_i)+D_i}{\mu\times C_{17/20}+D_i}
\end{equation}
Here, $\mu$ is the pulse shape determination factor, $D_i$ is the dark hit rate for the $i^{th}$ PMT and $C_{17/20}$ is the normalization constant for the 17 or 20 inch PMTs. The overall log-likelihood is given by the $log(L)=\sum_ilog(\phi_i)$. The log-likelihood is maximized by the Newton-Raphson method, in which the $x,y,z,T_0$ are adjusted to the best-fit values, giving us the V2 reconstructed vertex.

\subsection{Energy Reconstruction}
Likelihood maximization is also used to reconstruct the energy of an event. A likelihood PDF is constructed using the number of hits, charge, and hit timing.
\subsection*{$N_{hit}$ PDF}
The expectation of the number of photons hitting PMT i, $\mu_i$ is a function of the visible energy and dark charge.
\begin{equation}
	\mu_i = a_i(x,y,z)\times E_{vis} +d_i
\end{equation}
Here, $a_i(x,y,z)$ is a coefficient that converts the event energy to the number of photons which is calibrated with the neutron events. It is determined by the PMT position $x,y,z$. $d_i$ is the dark noise charge of PMT i, which is electronically measured. The probability that $\mu_i$ photons hit the $i$th PMT $j$ times, $k_{ij}$, is ideally expressed by the poisson distribution:
\begin{equation}
	k_{ij}=\frac{(\mu_i)^j}{j!}e^{-\mu}
\end{equation}

However, in KamLAND waveform analysis, the 1 p.e. detection efficiency is reduced by the 0.3 p.e. software charge threshold. This threshold is set to reduce the acceptance of dark noise but also decreases hit detection efficiency. As a result, the PMT hit probablity is reduced to:
\begin{equation}
	P_{hit}=1-v_ie^{-\mu_i}
\end{equation}

\subsection*{Hit Charge PDF}
A Gaussian distribution is assumed for the hit charge PDF of each PMT:
\begin{equation}
	f_{i,j(q_i)}=\frac{1}{\sqrt{2\pi j\sigma^2}}exp(-\frac{(q_i-j)^2}{2j\sigma^2})
\end{equation}
$q_i$ is the observed charge in p.e. units and $\sigma$ is  the charge resolution against 1 p.e. distribution.

\subsection*{Hit Time PDF}
PMT hit timing factors into energy reconstruction by helping to discriminate hits unrelated to the physical event. The hit timing model is created using source calibration data. 
\begin{equation}
	P_{time,i} = \frac{\psi(t_i)a_i E_{vis}+d_i}{\mu_i}
\end{equation}
The PDF is the sum of the signal hit distribution and the constant dark noise.
\subsection*{Energy Likelihood}
The likelihood function to be maximized is constructed as 
\begin{equation}
	L=\prod_{Not\ hit\ PMTs}P_{no-hit,i}\prod_{Hit\ PMTs}\left[P_{hit,i}\left(\sum_{j=1}^{100}f_{i,j}\right)P_{time, i}\right]
	\label{eq:energy_likelihood}
\end{equation}
The reconstructed energy is the one which maximizes this likelihood. The Newton-Raphson method is used to search for this energy. This process is implemented independently for the 17-inch PMTs and 20-inc PMTs, then the event energy is calculated with a weighting factor $\alpha$:
\begin{equation}
	E_{vis}=(1-\alpha)E_{17inch}+\alpha E_{20inch}
\end{equation}
The weighting factor $\alpha=0.3$ was determined to maximizing energy resolution.
\subsection{Bad Channels in Energy Reconstruction}
The increase in the number of low gain PMTs has lead to worsening energy resolution over time, as these PMTs are excluded from the typical energy reconstruction described above. In particular, some of the low gain PMTs still detect photons, but proper gain calibration is not possible. A method for utilizing the information from operational low gain PMTs was developed, and the basic strategy is as follows:
\begin{enumerate}
	\item The change in gain causes the effect of the 0.3 p.e. threshold on hit probability to change. The no-hit probability was expanded as follows:
	\begin{equation}
		P^{\prime}_{no-hit, i} = \left(1+\epsilon_1\mu_i+\epsilon_2\frac{\mu_i^2}{2!}+\epsilon_3\frac{\mu_i^3}{3!}\right)e^{-\lambda\mu_i}
	\end{equation}
	This model was originally a simple expansion of $P_{no-hit}$, but in the end was adjusted phenomologically to better reproduce real data. This adjustment is why an additional $e^{-\lambda\mu}$ appears in the model.
	\item The parameters $\epsilon_1, epsilon_2, epsilon_3,$ and $\lambda$ are estimated with actual data. The events satisfying the following selections are collected and the no-hit probability is calcualted for each expected charge. The expected charge of the i-th PMT $\mu_i$ is estimated using the vertex and total charge of the events that meet the following conditions.
	\begin{itemize}
		\item $r<6m$
		\item Not muons or events within 2 ms after muons
		\item Events with more than 120 17-inch PMT hits
		\item PMT waveforms that contain only 1 peak
	\end{itemize}
	Figure \ref{fig:nohit_prob} shows the result of fitting this adjusted no-hit probability model. THe fitting is performed run-by-run and for each PMT independently.
	\item Use the updated no-hit probability pdf in the event energy reconstruction in Equation \ref{eq:energy_likelihood}.
\end{enumerate}
\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.4]{no-hitprob.png}
	\caption{Fitting no hit probability to a low gain PMT against the expected charge $\mu$. The original model is shown with the blue line while the red line is the new model which agrees better with low-gain PMT data.}
	\label{fig:nohit_prob}
\end{figure}

Making use of the low-gain PMTs can improve energy resolution by up to 3\% \cite{karino_master}. Further analysis in this work uses energy reconstructed from the combination of normal and low-gain PMTs.

\subsection{Muon Reconstruction}
The selection and understanding of muon and muon-correlated neutrons are essential to multiple background rejections. This section, describes the special selection criteria and reconstruction methods used for muons and neutrons.
\subsection*{Muon Selectrion Criteria}
The muon event selection criteria are as follows:
\begin{itemize}
	\item Total charge of 17inch PMTs, $Q_{17}\geq 10000$ p.e.
	\item $Q_{17geq}$ 500 p.e. and the number of hit OD PMTS $\geq 9$.
\end{itemize}
The former criteria selects muons which go through the scintillator volumes of the detector. A total charge of 10,000 p.e. roughly corresponds to an event energy of 30 MeV, which exceeds the energy range of most physical analyses in KamLAND-ZEN. The second selection is for muons that only deposit energy in the outer buffer oil (clipping muons). Muons passing through the buffer oil volumes do not scintillate, as such the 500 p.e. threshold in Chrenkov radiation roughly corresponds to about 40 MeV of energy deposition.
\subsection{Cosmic Ray Muon Reconstruction}
Cosmic ray muon events form tracks as opposed to the point-like events caused by single decay events. The process is shown diagramattically in Figure \ref{fig:muon_reco}
\begin{enumerate}
	\item The ID PMT which detects the earliest light is identified. If the charge of this hit is low or isolated in time from the many other hits in the event, it is classed as a dark hit and ignored. A line is drawn from the earliest hit muon PMT and the center of the KamLAND detector. The intersection of this line and the outer balloon is marked as the temporary entrance point.
	\item The PMT whose charge is the largest is identified. The brightest hit PMT should be hit later than the earliest PMT and the neighbors of the earliest PMTs. A line is drawn from the brightest hit PMT and the center of the KamLAND detector. The intersection of this line and the outer balloon is marked as the temporary exit.
	\item The temporary track is defined as the line connecting the temporary entrance and exit. The temporary track is finally corrected by checking the correlation between the track length and the total charge.
	\item The reconstruction quality is evaluated by checking the following:
	\begin{itemize}
		\item Whether the earliest and the brightest PMTs can be identified
		\item Whether the mean hit time of PMTs around the entrance is earlier than the around the exit.
	\end{itemize}
	A "badness" parameter value is assigned to the reconstruction according to this evaluation. With this evaluation, around 15\% of muon candidates are regarded as badly reconstructed though they can still be used in muon-neutron pairing. Bad muon reconstruction is caused by ringing in the PMT signals, muon bundles, and stopped muons.
\end{enumerate}
The light yields in the muon events are estimated in \cite{karino_master}:
\begin{equation}
	\langle dQ_C/dX\rangle =28\pm 5\textbf{p.e./cm (Cherenkov muons)}
\end{equation}
\begin{equation}
	\langle dQ_S/dX\rangle =338\pm 12\textbf{p.e./cm (Scintillation muons)}
\end{equation}
\subsection{MoGURA Neutron Reconstruction}
Neutrons that are produced during cosmic ray spallation are best detected with the MoGURA DAQ due to the FBE's inability to handle the high after-pulse rate. After pulsing is also present in MoGURA and need to be rejected. An effective number of hits $N_s$ was introduced. The neutron reconstruction procedures is as follows:
\begin{enumerate}
	\item A 200ns wide time window is opened. The vertex is reconstructed using LT Vertex using the hit information contained in this window.
	\item The times of flight to each PMT is calculated assuming the reconstructed vertex. Then the ToF subtracted hit timing distribution is obtained.
	\item The obtained residual hit time distribution includes neutron capture 2.2 MeV gamma scintillation light and fake signals from after-pulses. To calculate the effective number of hits, $N_{in}$ and $N_{out}$, the number of hits in a 30ns wide "ontime" window and a 170ns wide "offtime" window respectively are counted. $N_s$ is then calculated as
	\begin{equation}
		N_s=N_{in}-N_{out}\times\frac{30 nsec}{170 nsec}
	\end{equation}
	\item The ontime window is shifted by 20ns, the clock time of MoGDAQ, and step 3 is repeated.
	\item The 200ns time window is shifted and steps 1-4 are repeated. the 200ns window and 30ns ontime window that maximizes $N_s$ is found. The vertex given by the $N_s$ maximizing time windows is taken as the reconstructed neutron capture event vertex.
\end{enumerate}
\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.4]{neutron_reco.png}
	\caption{A neutron capture events hit times showing the contribution of fake after pulses and the time windows used to calculate $N_s$}
	\label{fig:neutron_reco}
\end{figure}
\subsection{Muon Neutron Correlation}
The neutron selection process outlined above contains many noise events, thus the sample is only used in background discrimination when coincident with muons. In particular, MoGURA data neutrons are used to improve the rejection of xenon spallation products. The procedure for selecting muon-neutron pairs is:
\begin{enumerate}
	\item Check the end unixtime of the previous KamDAQ run and the start unixtime of the current KamDAQ run.
	\item Collect the MoGURA runs that collected data during this gap. Muon events collected by MoGURA are used in the gaps between KamDAQ runs, during KamDAQ runs muons collected with FBE data are used.
	\item The delayed coincidence analysis is done to select neutron candidate events in a short time period after muons. The first cuts applied are on $dT>2500\mu $ and $N_{s}=N_{in}-N_{out}<100$, these events are first removed. The subsequent MoGURA neutron selection criteria are outlined below.  
\end{enumerate}

The neutron selection in MoGURA is outlined in Figure \ref{fig:neutron_selection}. Two quantities are used, $dT$, the time delay between the neutron event and the previous muon, and $N_s$. From the 2D distribution, one sees that the event rate is higher in the short dT region due to noise and after-pulses. The $N_s$ values also tend to be small due to signal loss caused by baseline overshoot in the PMTs. The following criteria were chosen to select MoGURA neutrons:
\begin{itemize}
	\item $N_{total}=N_{in}+N_{out}>150$ (Number of hit requirement)
	\item $N_s>50 \wedge 10<dT<1200\mu s $ (reject after-pulses and accidental events)
	\item $!((N_s<dT(\mu s)+70\wedge 10<dT<20 \mu s )||N_s<-0.8\times dT(\mu s)+106\wedge20<dT<70\mu s)$
\end{itemize}
Figure \ref{fig:neutron_dT} shows the dT distribution of the MoGURA neutrons collected with the above criteria. The histogram is fitted to an exponential between 500 and 1000 $\mu s$, and the fitted function is extrapolated to the rest of the data range. The inefficiency of the neutron tag in the shorter dT period can be seen as the distribution turns off at low dT.

\begin{figure}[htb]
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[scale=0.3]{mog_neutron.png}
        \caption{distribution showing the $dT$ dependence of $N_s$. The events above the red line are selected as MoGURA neutrons and used for background rejection \cite{takeuchi_phd}}
        \label{fig:neutron_selection}
    \end{minipage}
    \hfill
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[scale=0.3]{mog_neutron_dt.png}
        \caption{The $dT$ distribution of selected MoGURA neutrons. The fit to an exponential is performed between 500 and 1000 $\mu s$. \cite{takeuchi_phd}}
        \label{fig:neutron_dT}
    \end{minipage}
\end{figure}

\section{Event Selection}
Candidate \0nbb events must pass several event selections. The selections are separated into non-physical events and background cuts. In this section, we first describe the event selections used in this analysis. Then, the impact of these selections on signal inefficiency are discussed.

\subsection{Unphysical and Bad Quality Event Rejection}
Much of the data saved in the KamLAND DAQ systems include "unphysical" events. Furthermore, much of the events associated with real physical processes are of poor quality. This section, describes the criteria by which unphysical events and poor quality events are selected.
\begin{enumerate}
	\item Flasher PMT \\
	PMTs, can occasionally emit light into the detector. These occurances are called PMT flashers. There are multiple potential causes for a PMT to flash, such as the discharge of the dynodes and light emission from the epoxy around the breeder circuit. Figure \ref{fig:flasher} shows the typical event display of a flasher event. Such events have a distint signature, as the PMT that flashes will have exceptionally high charge and cause a huge deposition of charge in the nearest PMTs as well. The PMT flasher selection criteria are as follows:
	\begin{itemize}
		\item Total charge of ID PMTs $ > 2500$ p.e.
		\item Maximum ID PMT charge/Total ID PMT Charge $ >60\%$
		\item Average charge of the neighboring PMTs $ > 20$ p.e.
	\end{itemize}
	\begin{figure}[htb!]
		\centering
        \includegraphics[scale=0.45]{flasher.png}
        \caption{Event display of a flasher event. The left shows the charge distribution. One PMT has an exceptionally large charge. Right shows the time distribution. It is relatively flat since the source is not scintillator. The hit timing of the flasher PMTs and its neighbors are very early.}
        \label{fig:flasher}
	\end{figure}
	\item Post muon events \\
	Cosmic ray muons deposit a large amount of energy into the detector. As a result, the detecotr behavior is unstable for a period afterwards. In particular, the detector suffers from a high fake event rate due to after-pulsing and the shift of baseline from overshoot. This instability causes not only a large amount of unphyiscal events, but also degrade the reconstructibility of real physical events. Thus, all events in the immediate 2 msec after cosmic ray muons are not uesd for the excited state analysis. Though, these events may be used for other analyses such as spallation background estimation.
	\item Missing waveform events \\
	High rate after-pulsing from cosmic ray muons can also cause the ATWD to be busy and the DAQ system to get stuck. When the DAQ electronics are in this state, event waveforms cannot be recorded. These are referred to as "missing waveform" events. In these situations, the number of hit 17-inch PMTs within 125 ns after a trigger issue is recorded as "NsumMax". In properly recorded events, NsumMax should be proportional to the total number of 17inch PMT hits (Nhit17). So the missing waveform events are identified by the ratio between NsumMax and Nhit17; the distributions of these two quantities are shown in Figure \ref{fig:missing_waveform}. Events tagged by this selection are removed from the excited state physics analysis. The exact selection criteria are as follows:
	\begin{itemize}
		\item Nhit17 $<$ NsumMax $\times 0.99-25$
		\item $dT$ after muon events $< 2$ msec (if NsumMax<1200)
		\item $dT$ after muon events $< 2$ sec (if NsumMax>1200)
	\end{itemize}
	\begin{figure}[htb]
		\centering
        \includegraphics[scale=0.45]{missing_waveform.png}
        \caption{Nhit17 vs NHitSumMax distributions for all physics events (left) and Bi214-tagged events (right). The missing waveform cut inefficiency can be calculate from the Bi214-tagged events to be $< 0.01\%$}.
        \label{fig:missing_waveform}
	\end{figure}
	\item Post PPS trigger event \\
	The PPS trigger is a forced trigger issued once a second used for constant diagnostic monitoring of the detector. However, the PPS trigger has been found to cause an increase in electronics noise and DAQ trigger rate. Thus events 100 $\mu sec$ from the last PPS trigger are removed from the analysis.
	\item Badly reconstructed events \\
	The fit quality of an event's vertex reconstruction is the event's "Badness". The quantity is calculated using nine parameters that describe the deviation of an event's PMT hit and charge distribution from the expectation. A detailed explanation of the Badness calculation can be found in section 3.8.3 of \cite{}. These poorly reconstructed events mostly consist of, noise events and pileup. The events with large Badness are removed from the analysis by the following energy-dependent threshold:
	\begin{equation}
		Badness < 25.0\times exp(-4.5\times E_{vis} [MeV]) + 3.1
	\end{equation}
	Figure \ref{fig:badness} shows the Badness distribution of all physical events and the Badness of $^{214}$Bi events selected by the delayed coincidence method.
	\begin{figure}[htb]
		\centering
        \includegraphics[scale=0.45]{badness.png}
        \caption{The badness distributions of all physics events (left) and Bi214-tagged events (right)}
        \label{fig:badness}
	\end{figure}
\end{enumerate}

\section{Background Rejection}
\subsection{Uranium/Thorium}
$^{214}$Bi and $^{212}$Bi are radioactive nuclei produced in the uranium and thorium decay series, respectively. They are among the dominant backgrounds in KamLAND-ZEN. These isotopes are introduced to the detector primarily by Uranium/Thorium contamination in the LS itself or on the surface of the inner balloon. There were also some $^{222}$Rn introduced when the XeLS was filled, this decayed with a half-life of 3.8 days, as such the $^{222}$Rn-related $^{214}$Bi decayed away in the early stages of KamLAND-ZEN 800. This time-dependence of the Radon background is accounted for in the physics analysis.
These Bismuth-decays are tagged in two ways: Delayed-coincidence veto and Double-pulse fitting.
\subsection*{Delayed Coincidence Veto}
Both $^{214}$Bi and $^{212}$Bi decays are quickly followed by the decays of $^{214}$Po/$^{212}$Po:

\begin{equation}
\begin{aligned}
&^{214}\mathrm{Bi}
\ \xrightarrow[\substack{19.9\,\mathrm{min},\ 99.98\%}]{\beta^-,\ Q=3.27\,\mathrm{MeV}}
\ ^{214}\mathrm{Po}
\ \xrightarrow[\substack{164.3\,\mu\mathrm{s}}]{\alpha,\ Q=7.83\,\mathrm{MeV}}
\ ^{210}\mathrm{Pb}
\end{aligned}
\end{equation}

\begin{equation}
\begin{aligned}
&^{212}\mathrm{Bi}
\ \xrightarrow[\substack{60.55\,\mathrm{min},\ 99.98\%}]{\beta^-,\ Q=2.25\,\mathrm{MeV}}
\ ^{212}\mathrm{Po}
\ \xrightarrow[\substack{0.299\,\mu\mathrm{s}}]{\alpha,\ Q=8.95\,\mathrm{MeV}}
\ ^{208}\mathrm{Pb}
\end{aligned}
\end{equation}
These decays are correlated in space and time in KamLAND, they can be vetoed by searching for this correlation. The criteria of the Bi-Po delayed coincidence analysis used in the KamLAND-ZEN analysis is as follows:
\begin{itemize}
	\item delayed energy : $0.2 < E_d < 1.3$ MeV
	\item distance between prompt and delayed vertices : $dR<170$ cm
	\item timing delay between prompt and delayed vertices : $dT<1.9$msec
\end{itemize}

Figure \ref{fig:BiPo214} shows the delayed-coincidence veto parameter distributions used in the $^{214}$Bi selection. Coincident pairs within 10 $\mu sec$ are excluded and set aside for the $^{212}$Bi selection, as $^{212}$Po has a much shorter half-life. The delayed energy deposition distribution, two peaks are found. THe lower energy peak corresponds to polonium decays in which some energy is deposited not in the liquid scintillator but in the mini-balloon nylon film.
\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.45]{bi214.png}
	\caption{The delayed coincidence selection parameters for $^{214}$Bi. The distributions of prompt energy, delayed energy, displacement, and delay time are shown. The blue shaded regions indicate the tagged events. Events with $dT<10\mu sec$ are set aside for $^{212}$Bi-Po selection.}
	\label{fig:BiPo214}
\end{figure}
Figure \ref{fig:BiPo212} shows the delayed-coincidence veto parameter distributions used in the $^{212}$Bi selection. For this selection, the timing selection is $dT<10\mu sec$. The veto efficiency of $^{214}$Bi-Po decays in the XeLS is $99.89\pm0.03\%$. The veto efficiency of $^{214}$Bi-Po decays in the balloon film is $48.9\pm9\%$. The lower veto efficiency is due to alpha decays depositing their energy in the film not the liquid scintillator. For $^{212}$Po decays that occur immediately after the initial $^{212}$Bi decay, they can be tagged by the double pulse fitter, which the next section describes.
\begin{figure}[htb]
	\centering
	\includegraphics[scale=0.45]{bi212.png}
	\caption{The delayed coincidence selection parameters for $^{212}$Bi. The distributions of prompt energy, delayed energy, displacement, and delay time are shown. The yellow shaded regions indicate the tagged events. Only events with $dT<10\mu sec$ are used for this selection.}
	\label{fig:BiPo212}
\end{figure}
\subsection*{Double Pulse Fitter}
When the delay time, $dT$, between prompt and delayed events are small enough, Bi-Po sequential events can be stored as a single event in KamLAND's data acquisition window. In these cases, the delayed coincidence selection of two related events does not work. Such events are referred to as pile-up events. Since these pileup events contain the kinetic energy of the initial beta decay and the subsequent alpha decay, the combined deposited energy reaches beyond the \0nbb ROI and becomes an important background to reduce. The energy spectrum of these $^{212}$Bi-Po pile-up events are shown in Figure \ref{fig:BiPo_energy}.

A double pulse fit method has been developed to tag these pile-up events. The method simply searches for events with a hit-timing distribution indicative of two distinct energy depositions, or hit time peaks. The hit time distribution of an event is fitted with 2 reference waveforms by the following procedure:
\begin{enumerate}
	\item Construct a reference time profile.
	A reference waveform is made from the hit time profile of \2nbb-decay candidates. The events are selected with $1.4 < E_{vis}<1.6$ MeV and $radius < 157$ cm after \0nbb background vetoes. 
	\item Construct the hit timing profile of \0nbb decay candidates.
	\item Fit the event's hit time profile
	\item Correct the reconstructed energies
	\item Candidate selection
\end{enumerate}


\subsection{Antineutrinos}
\subsection{Short-lived Spallation Products}
\subsection{Shower Veto}
\subsection{Xenon Spallation Products}
\subsection{Signal Inefficiency}

